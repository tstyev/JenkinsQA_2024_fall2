name: Notify

on:
  workflow_run:
    workflows: [ "pages-build-deployment" ]
    types:
      - completed
jobs:
  notify:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Find the latest CI run
        uses: actions/github-script@v6
        id: find_ci_run
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 50,
            });
            const ciRuns = runs.data.workflow_runs
              .filter(run => run.name === "CI" && run.status === "completed" && (run.conclusion === "success" || run.conclusion === "failure"))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const latestCiRun = ciRuns[0];
            const runNumber = latestCiRun.run_number;
            core.setOutput("run_number", runNumber);
            core.setOutput("run_id", latestCiRun.id);
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      #      - name: Send Telegram Notification
      #        run: |
      #          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
      #          REPORT_LINK="https://evgnick.github.io/JenkinsQA_2024_fall2/${{ steps.find_ci_run.outputs.run_number }}/"
      #          CI_RUN_LINK="https://github.com/${{ github.repository }}/actions/runs/${{ steps.find_ci_run.outputs.run_id }}"
      #
      #          ESCAPED_TIMESTAMP=$(echo "$TIMESTAMP" | sed 's|-|\\-|g; s|:|\\:|g; s|\.|\\.|g; s|_|\\_|g; s|/|\\/|g')
      #          ESCAPED_REPORT_LINK=$(echo "$REPORT_LINK" | sed 's|-|\\-|g; s|\.|\\.|g; s|_|\\_|g; s|:|\\:|g; s|/|\\/|g')
      #          ESCAPED_CI_RUN_LINK=$(echo "$CI_RUN_LINK" | sed 's|-|\\-|g; s|\.|\\.|g; s|_|\\_|g; s|:|\\:|g; s|/|\\/|g')
      #
      #          MESSAGE="ðŸ“ ÐÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Allure: [Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚](${ESCAPED_REPORT_LINK})%0AðŸ“… Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ: ${ESCAPED_TIMESTAMP}%0Aâš™ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ°: ${{ steps.find_ci_run.outputs.run_number }}%0AðŸ”— Ð—Ð°Ð¿ÑƒÑÐº: [Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐº](${ESCAPED_CI_RUN_LINK})"
      #
      #          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
      #            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
      #            -d text="${MESSAGE}" \
      #            -d parse_mode="MarkdownV2"

      - name: Download Allure Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Extract Test Results
        id: test_results
        run: |
          PASSED=$(jq '.statistic.passed' allure-report/widgets/summary.json)
          FAILED=$(jq '.statistic.failed' allure-report/widgets/summary.json)
          BROKEN=$(jq '.statistic.broken' allure-report/widgets/summary.json)
          TOTAL=$(($PASSED + $FAILED + $BROKEN))
          
          DURATION_MS=$(jq '.time.duration' allure-report/widgets/summary.json)
          DURATION_SEC=$(($DURATION_MS / 1000))
          DURATION_MIN=$(($DURATION_SEC / 60))
          DURATION_FINAL="${DURATION_MIN} Ð¼Ð¸Ð½ ${DURATION_SEC} ÑÐµÐº"
          
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "BROKEN=$BROKEN" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "DURATION_FINAL=$DURATION_FINAL" >> $GITHUB_ENV

      - name: Install Python dependencies
        run: pip install matplotlib

      - name: Generate Test Results Chart
        run: |
          python <<EOF
          import matplotlib.pyplot as plt
          
          labels = ["Passed", "Failed", "Broken"]
          sizes = [${{ env.PASSED }}, ${{ env.FAILED }}, ${{ env.BROKEN }}]
          colors = ["#4CAF50", "#F44336", "#FFC107"]
          
          plt.figure(figsize=(4, 4))
          plt.pie(sizes, labels=labels, autopct='%1.1f%%', colors=colors, startangle=140)
          plt.title(f"Test Results: ${{ env.TOTAL }} tests")
          
          plt.savefig("test_results.png")
          EOF

      - name: Send Slack Notification
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
          REPORT_LINK="https://evgnick.github.io/JenkinsQA_2024_fall2/${{ steps.find_ci_run.outputs.run_number }}/"
          CI_RUN_LINK="https://github.com/${{ github.repository }}/actions/runs/${{ steps.find_ci_run.outputs.run_id }}"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendPhoto" \
          -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -F photo="@test_results.png" \
          -F caption="ðŸ“ ÐÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Allure: [ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚ ](https://redroverschool.github.io/JenkinsQA_2024_fall/${{ steps.find_ci_run.outputs.run_number }})%0A
          ðŸ“… Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ: $(date +"%Y-%m-%d %H:%M:%S")%0A
          âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ…: ${{ env.PASSED }}%0A
          âŒ ÐŸÑ€Ð¾Ð²Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ…: ${{ env.FAILED }}%0A
          âš ï¸ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ñ…: ${{ env.BROKEN }}%0A
          ðŸ”¢ Ð’ÑÐµÐ³Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²: ${{ env.TOTAL }}%0A
          â±ï¸ Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: ${{ env.DURATION_FINAL }}%0A
          ðŸ”— Ð—Ð°Ð¿ÑƒÑÐº: [ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐº ](https://github.com/${{ github.repository }}/actions/runs/${{ steps.find_ci_run.outputs.run_id }})" \
            -F parse_mode="MarkdownV2"
#          MESSAGE="ðŸ“ ÐžÑ‚Ñ‡ÐµÑ‚: [Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚](${REPORT_LINK})%0AðŸ“… Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ: ${TIMESTAMP}%0AðŸ”¢ Ð’ÑÐµÐ³Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²: ${{ env.TOTAL }}%0Aâœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ…: ${{ env.PASSED }}%0AâŒ ÐŸÑ€Ð¾Ð²Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ…: ${{ env.FAILED }}%0Aâš ï¸ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ñ…: ${{ env.BROKEN }}%0Aâ±ï¸ Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: ${{ env.DURATION_FINAL }}%0AðŸ”— Ð—Ð°Ð¿ÑƒÑÐº: [Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐº](${CI_RUN_LINK})"
#                    curl -X POST -H 'Content-type: application/json' \
#                      --data "{\"text\": \"$MESSAGE\"}" \
#                      ${{ secrets.SLACK_WEBHOOK_URL }}
#                    MESSAGE="*ÐÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Allure*\nðŸ“… *Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ*: $TIMESTAMP\nâš™ï¸ *Ð¡Ð±Ð¾Ñ€ÐºÐ°*: ${{ steps.find_ci_run.outputs.run_number }}\nðŸ”— *<$REPORT_LINK|ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚>*\nðŸ”— *<$CI_RUN_LINK|ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐº>*"
